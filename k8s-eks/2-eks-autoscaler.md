# Complete Guide to Deploying Amazon EKS Cluster Autoscaler

## Steps 1: Create IAM Policy for Cluster Autoscaler [Get Policy](https://github.com/kubernetes/autoscaler/blob/master/cluster-autoscaler/cloudprovider/aws/README.md)

`aws iam create-policy --policy-name AmazonEKSClusterAutoscalerPolicy --policy-document file://2.0-autoscaler-iam-policy.json`


## üîó Steps 2: Configure OIDC Trust Relationship
Retrieve OIDC Provider URL & Create 2.1-autoscaler-trust-policy.json with the correct values.

`aws eks describe-cluster --name devops-b1-eks --region us-east-2 --query "cluster.identity.oidc.issuer" --output text`

Output should be like this `https://oidc.eks.us-east-2.amazonaws.com/id/DAE96D76870392A561ABB62ECA6D9A3B`

**DAE96D76870392A561ABB62ECA6D9A3B** EKS cluster‚Äôs OIDC provider ID ‚Äî it's a unique identifier generated by AWS for your cluster's OIDC issuer URL

**605134426044** AWS Account ID

`vim 2.1-autoscaler-trust-policy.json`

```
{
  "Version": "2012-10-17",
  "Statement": [
    {
      "Effect": "Allow",
      "Principal": {
        "Federated": "arn:aws:iam::605134426044:oidc-provider/oidc.eks.us-east-2.amazonaws.com/id/DAE96D76870392A561ABB62ECA6D9A3B"
      },
      "Action": "sts:AssumeRoleWithWebIdentity",
      "Condition": {
        "StringEquals": {
          "oidc.eks.us-east-2.amazonaws.com/id/DAE96D76870392A561ABB62ECA6D9A3B:aud": "sts.amazonaws.com",
          "oidc.eks.us-east-2.amazonaws.com/id/DAE96D76870392A561ABB62ECA6D9A3B:sub": "system:serviceaccount:kube-system:cluster-autoscaler"
        }
      }
    }
  ]
}

```
## üõ°Ô∏è Steps 3: Create and Attach IAM Role for Cluster Autoscaler


Create the IAM role using the trust policy and attach the autoscaler policy.

`aws iam create-role --role-name AmazonEKSClusterAutoscalerRole --assume-role-policy-document file://2.1-autoscaler-trust-policy.json`


Retrieve the Policy ARN with AWS CLI for attach this policy with ClusterAutoscalerRole.

`aws iam list-policies --scope Local --query "Policies[?PolicyName=='AmazonEKSClusterAutoscalerPolicy'].Arn" --output text`

Attach Policy with Cluster Auto Scaler Role Using ARN.

`aws iam attach-role-policy --role-name AmazonEKSClusterAutoscalerRole --policy-arn arn:aws:iam::605134426044:policy/AmazonEKSClusterAutoscalerPolicy`


## Steps 4: Apply EKSClusterAutoscal manifest, download from [Here](https://github.com/kubernetes/autoscaler/blob/master/cluster-autoscaler/cloudprovider/aws/examples/cluster-autoscaler-autodiscover.yaml)

`vim 2.2-cluster-autoscaler-autodiscover.yaml`

**Note: Before apply, retrieved OIDC provider and AWS account ID to create autoscaler-trust-policy.json**

**Update 4.1:** Add IAM Role Annotation to ServiceAccount
```bash
apiVersion: v1
kind: ServiceAccount
metadata:
  labels:
    k8s-addon: cluster-autoscaler.addons.k8s.io
    k8s-app: cluster-autoscaler
  # Add this annotations
  annotations:
    eks.amazonaws.com/role-arn: arn:aws:iam::605134426044:role/AmazonEKSClusterAutoscalerRole
  name: cluster-autoscaler
  namespace: kube-system
```
**Note: You can retrieve the mazonEKSClusterAutoscalerRole ARN using the following command**\
`aws iam get-role --role-name AmazonEKSClusterAutoscalerRole --query "Role.Arn" --output text`

**Update 4.2:** Match Image with EKS Version

```bash
containers:
   - image: registry.k8s.io/autoscaling/cluster-autoscaler:v1.31.1
```
**Update 4.3:** Set Correct Cluster Name for Auto Discovery

```bash
- --node-group-auto-discovery=asg:tag=k8s.io/cluster-autoscaler/enabled,k8s.io/cluster-autoscaler/meetup-may2025
```
**Apply EKS cluster autoscaler-autodiscover manifest file**\
`kubectl apply -f 2.2-cluster-autoscaler-autodiscover.yaml`

## üîê Steps 5: Associate IAM OIDC Provider (IRSA Setup)
Enables secure IAM access for Kubernetes pods via IRSA ((IAM Roles for Service Accounts)) by linking your EKS cluster's OIDC identity with AWS.

`eksctl utils associate-iam-oidc-provider --cluster devops-b1-eks --approve`


## üìä Steps 6: Install Metric Server from [Here](https://docs.aws.amazon.com/eks/latest/userguide/metrics-server.html)


## üß™ Step 7: Test Autoscaler with Pod Scaling, Trigger a scale-up event by creating a high number of replicas.

`kubectl create deployment nginx --image=nginx --replicas=100`

`kubectl get node`

